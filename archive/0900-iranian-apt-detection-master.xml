<!--
  Wazuh Rules for Iranian APT Detection - Master Ruleset
  Version: 3.0
  Last Updated: 2025-06-27
  
  This master ruleset combines all Iranian APT detection rules including:
  - CVE exploitation detection
  - Behavioral patterns and tool detection
  - Network-based indicators
  - Unique Iranian APT signatures
  - Advanced APT group-specific detections
  
  Iranian APT Groups Covered:
  - Pioneer Kitten (Fox Kitten, UNC757, Parisite)
  - Lemon Sandstorm (formerly Rubidium)
  - Peach Sandstorm (APT33, Elfin, Refined Kitten)
  - MuddyWater (Mercury, Static Kitten, TEMP.Zagros)
  - APT34 (OilRig, Crambus, Helix Kitten)
  - APT35 (Charming Kitten, Phosphorus, TA455)
  - IRGC-affiliated groups
  
  Rule ID Ranges:
  - 100900-100919: CVE exploitation detection
  - 100920-100939: Behavioral detection
  - 100940-100959: Network detection
  - 100960-100999: Advanced APT group-specific rules
  - 101000-101023: Unique behaviors and signatures
-->

<group name="iranian_apt,">

  <!-- ========== CVE EXPLOITATION DETECTION (100900-100919) ========== -->
  
  <!-- CVE-2024-24919: Check Point Security Gateway -->
  <rule id="100900" level="15">
    <if_group>web</if_group>
    <url>/clients/MyCRL</url>
    <description>Iranian APT: CVE-2024-24919 Check Point exploitation attempt</description>
    <mitre>
      <id>T1190</id>
    </mitre>
  </rule>

  <!-- CVE-2024-3400: Palo Alto PAN-OS -->
  <rule id="100902" level="15">
    <if_group>web</if_group>
    <url>/ssl-vpn/hipreport.esp</url>
    <description>Iranian APT: CVE-2024-3400 PAN-OS exploitation attempt</description>
    <mitre>
      <id>T1190</id>
    </mitre>
  </rule>

  <!-- CVE-2023-3519: Citrix NetScaler -->
  <rule id="100904" level="15">
    <if_group>web</if_group>
    <url>/pcidss/report</url>
    <description>Iranian APT: Citrix NetScaler exploitation attempt</description>
    <mitre>
      <id>T1190</id>
    </mitre>
  </rule>

  <!-- CVE-2022-1388: F5 BIG-IP -->
  <rule id="100906" level="15">
    <if_group>web</if_group>
    <match>X-F5-Auth-Token</match>
    <description>Iranian APT: F5 BIG-IP CVE-2022-1388 exploitation attempt</description>
    <mitre>
      <id>T1190</id>
    </mitre>
  </rule>

  <rule id="100907" level="15">
    <if_group>web</if_group>
    <url>/mgmt/tm/util/bash</url>
    <description>Iranian APT: F5 BIG-IP command execution attempt</description>
    <mitre>
      <id>T1059</id>
    </mitre>
  </rule>

  <!-- CVE-2024-21887: Ivanti Connect Secure -->
  <rule id="100908" level="15">
    <if_group>web</if_group>
    <url>/api/v1/license/key-status/</url>
    <description>Iranian APT: Ivanti CVE-2024-21887 command injection attempt</description>
    <mitre>
      <id>T1190</id>
    </mitre>
  </rule>

  <!-- CVE-2020-1472: Zerologon -->
  <rule id="100910" level="15">
    <if_group>windows,authentication_failed</if_group>
    <field name="win.eventdata.workstation">\\0\\0\\0\\0\\0\\0\\0\\0</field>
    <description>Iranian APT: Zerologon (CVE-2020-1472) exploitation attempt</description>
    <mitre>
      <id>T1068</id>
    </mitre>
  </rule>

  <!-- CVE-2021-26855: Exchange ProxyLogon -->
  <rule id="100915" level="15">
    <if_group>web</if_group>
    <url>/owa/auth/x.js</url>
    <description>Iranian APT: Exchange ProxyLogon exploitation attempt</description>
    <mitre>
      <id>T1190</id>
    </mitre>
  </rule>

  <rule id="100916" level="15">
    <if_group>web</if_group>
    <match>X-AnonResource-Backend</match>
    <description>Iranian APT: Exchange Server suspicious headers detected</description>
    <mitre>
      <id>T1190</id>
    </mitre>
  </rule>

  <!-- CVE-2023-23397: Outlook NTLM Relay -->
  <rule id="100918" level="15">
    <if_group>windows</if_group>
    <match>Outlook.exe</match>
    <match>\\\\</match>
    <match>reminder</match>
    <description>Iranian APT: Outlook CVE-2023-23397 NTLM relay attempt</description>
    <mitre>
      <id>T1187</id>
    </mitre>
  </rule>

  <!-- ========== BEHAVIORAL DETECTION (100920-100939) ========== -->

  <!-- Remote Access Tools -->
  <rule id="100920" level="14">
    <if_group>sysmon_event_1</if_group>
    <match>anydesk.exe</match>
    <description>Iranian APT: AnyDesk remote access tool execution</description>
    <mitre>
      <id>T1219</id>
    </mitre>
  </rule>

  <rule id="100921" level="14">
    <if_group>sysmon_event_1</if_group>
    <match>ngrok.exe</match>
    <description>Iranian APT: Ngrok tunneling tool execution</description>
    <mitre>
      <id>T1572</id>
    </mitre>
  </rule>

  <!-- Web Shell Detection -->
  <rule id="100922" level="15">
    <if_group>web</if_group>
    <match>cmd=</match>
    <description>Iranian APT: Web shell command execution attempt</description>
    <mitre>
      <id>T1505.003</id>
    </mitre>
  </rule>

  <!-- Known Backdoors -->
  <rule id="100924" level="15">
    <if_group>sysmon_event_1</if_group>
    <match>havoc</match>
    <description>Iranian APT: Havoc backdoor execution detected</description>
    <mitre>
      <id>T1055</id>
    </mitre>
  </rule>

  <!-- Persistence -->
  <rule id="100925" level="14">
    <if_sid>5706</if_sid>
    <match>schtasks</match>
    <match>powershell</match>
    <description>Iranian APT: Scheduled task persistence detected</description>
    <mitre>
      <id>T1053.005</id>
    </mitre>
  </rule>

  <!-- Credential Theft -->
  <rule id="100927" level="15">
    <if_group>sysmon_event_1</if_group>
    <match>mimikatz</match>
    <description>Iranian APT: Mimikatz credential dumping tool detected</description>
    <mitre>
      <id>T1003</id>
    </mitre>
  </rule>

  <!-- PowerShell Abuse -->
  <rule id="100932" level="14">
    <if_group>windows</if_group>
    <match>powershell.exe</match>
    <match>-enc</match>
    <description>Iranian APT: Encoded PowerShell execution detected</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
  </rule>

  <!-- Exchange Web Shell -->
  <rule id="100936" level="15">
    <if_group>sysmon_event_11</if_group>
    <match>\\inetpub\\wwwroot\\aspnet_client</match>
    <match>.aspx</match>
    <description>Iranian APT: Suspicious file in Exchange directory</description>
    <mitre>
      <id>T1505.003</id>
    </mitre>
  </rule>

  <!-- ========== NETWORK DETECTION (100940-100959) ========== -->

  <!-- Unitronics PLC -->
  <rule id="100940" level="14">
    <if_group>firewall</if_group>
    <srcport>20256</srcport>
    <description>Iranian APT: Unitronics PLC port communication</description>
    <mitre>
      <id>T1571</id>
    </mitre>
  </rule>

  <!-- Suspicious User Agents -->
  <rule id="100941" level="14">
    <if_group>web</if_group>
    <match>User-Agent: Python</match>
    <description>Iranian APT: Python script user-agent detected</description>
    <mitre>
      <id>T1071.001</id>
    </mitre>
  </rule>

  <!-- Cobalt Strike -->
  <rule id="100944" level="15">
    <if_group>ids</if_group>
    <match>Cobalt Strike</match>
    <description>Iranian APT: Cobalt Strike beacon detected</description>
    <mitre>
      <id>T1001</id>
    </mitre>
  </rule>

  <!-- Port Scanning -->
  <rule id="100946" level="13" frequency="50" timeframe="60">
    <if_group>firewall</if_group>
    <match>drop</match>
    <same_src_ip />
    <description>Iranian APT: Port scanning detected</description>
    <mitre>
      <id>T1046</id>
    </mitre>
  </rule>

  <!-- Known C2 Domains -->
  <rule id="100949" level="15">
    <if_group>sysmon_event_22,web</if_group>
    <match>gupdate.net</match>
    <description>Iranian APT: Known C2 domain detected</description>
    <mitre>
      <id>T1071.001</id>
    </mitre>
  </rule>

  <!-- Ngrok Tunneling -->
  <rule id="100952" level="15">
    <if_group>firewall,sysmon_event_3</if_group>
    <match>ngrok.io</match>
    <description>Iranian APT: Ngrok tunnel service detected</description>
    <mitre>
      <id>T1090.001</id>
    </mitre>
  </rule>

  <!-- ========== ADVANCED APT GROUP-SPECIFIC RULES (100960-100999) ========== -->

  <!-- MuddyWater PowGoop DLL Side-Loading -->
  <rule id="100960" level="12">
    <if_group>sysmon_event_1</if_group>
    <field name="win.eventdata.image">rundll32.exe</field>
    <field name="win.eventdata.parentImage">GoogleUpdate.exe</field>
    <description>Iranian APT: MuddyWater PowGoop DLL Side-Loading - GoogleUpdate.exe spawned rundll32.exe</description>
    <mitre>
      <id>T1574.002</id>
      <id>T1036</id>
    </mitre>
  </rule>

  <!-- APT34/OilRig QUADAGENT Persistence -->
  <rule id="100961" level="10">
    <if_group>sysmon_event_1</if_group>
    <field name="win.eventdata.image">schtasks.exe</field>
    <match>/create /tn "Office365DCOMCheck"</match>
    <description>Iranian APT: APT34/OilRig QUADAGENT Persistence via Office365DCOMCheck task</description>
    <mitre>
      <id>T1053.005</id>
    </mitre>
  </rule>

  <rule id="100962" level="10">
    <if_group>sysmon_event_1</if_group>
    <field name="win.eventdata.image">schtasks.exe</field>
    <match>/create /tn "SystemDiskClean"</match>
    <description>Iranian APT: APT34/OilRig QUADAGENT Persistence via SystemDiskClean task</description>
    <mitre>
      <id>T1053.005</id>
    </mitre>
  </rule>

  <!-- Charming Kitten PowerLess Backdoor -->
  <rule id="100963" level="12">
    <if_group>windows</if_group>
    <field name="win.system.eventID">4104</field>
    <match>trying to get the C&C command</match>
    <description>Iranian APT: Charming Kitten PowerLess Backdoor C2 communication detected</description>
    <mitre>
      <id>T1059.001</id>
      <id>T1027</id>
    </mitre>
  </rule>

  <rule id="100964" level="12">
    <if_group>windows</if_group>
    <field name="win.system.eventID">4104</field>
    <match>PowerLess Backdoor Started</match>
    <description>Iranian APT: Charming Kitten PowerLess Backdoor initialization detected</description>
    <mitre>
      <id>T1059.001</id>
      <id>T1027</id>
    </mitre>
  </rule>

  <rule id="100965" level="12">
    <if_group>windows</if_group>
    <field name="win.system.eventID">4104</field>
    <match>Stealed data</match>
    <description>Iranian APT: Charming Kitten PowerLess Backdoor data theft detected</description>
    <mitre>
      <id>T1059.001</id>
      <id>T1005</id>
    </mitre>
  </rule>

  <!-- APT35/TA455 SnailResin DLL -->
  <rule id="100966" level="10">
    <if_group>sysmon_event_11</if_group>
    <field name="win.eventdata.targetFilename">secur32.dll</field>
    <field name="win.eventdata.image">SignedConnection.exe</field>
    <description>Iranian APT: APT35/TA455 SnailResin DLL dropped for side-loading</description>
    <mitre>
      <id>T1574.002</id>
    </mitre>
  </rule>

  <!-- APT33 YARA Detection -->
  <rule id="100967" level="15">
    <if_group>yara</if_group>
    <field name="yara.rule">APT33_TurnedUp_PDB_Artifact</field>
    <description>Iranian APT: APT33 TurnedUp malware artifact detected via YARA</description>
    <options>alert_by_email</options>
    <mitre>
      <id>S0199</id>
    </mitre>
  </rule>

  <!-- ========== UNIQUE BEHAVIORS (101000-101023) ========== -->

  <!-- DNS Hijacking -->
  <rule id="101000" level="14">
    <if_group>sysmon_event_22</if_group>
    <field name="win.eventdata.queryName">acme-v02.api.letsencrypt.org</field>
    <description>Iranian APT: Let's Encrypt query - DNS hijacking preparation</description>
    <mitre>
      <id>T1584.002</id>
    </mitre>
  </rule>

  <!-- Tehran Business Hours -->
  <rule id="101002" level="13">
    <if_group>authentication_success</if_group>
    <time>02:00 - 10:00</time>
    <description>Iranian APT: Authentication during Tehran business hours</description>
    <mitre>
      <id>T1078</id>
    </mitre>
  </rule>

  <!-- Farsi Language -->
  <rule id="101004" level="14">
    <if_group>web</if_group>
    <match>Accept-Language: fa-IR</match>
    <description>Iranian APT: Farsi language preference detected</description>
    <mitre>
      <id>T1071.001</id>
    </mitre>
  </rule>

  <!-- Cryptocurrency Mining -->
  <rule id="101006" level="14">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationPort">3333</field>
    <match>xmrig</match>
    <description>Iranian APT: Cryptocurrency mining detected</description>
    <mitre>
      <id>T1496</id>
    </mitre>
  </rule>

  <rule id="101007" level="15">
    <if_group>sysmon_event_1</if_group>
    <match>--donate-level 0</match>
    <description>Iranian APT: XMRig miner with no donation</description>
    <mitre>
      <id>T1496</id>
    </mitre>
  </rule>

  <!-- DNS Tunneling -->
  <rule id="101008" level="14">
    <if_group>sysmon_event_22</if_group>
    <field name="win.eventdata.queryType">16</field>
    <match>cmd</match>
    <description>Iranian APT: DNS TXT record C2 pattern</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
  </rule>

  <!-- Email Theft -->
  <rule id="101010" level="15">
    <if_group>web</if_group>
    <url>mail.google.com</url>
    <match>ui=html</match>
    <description>Iranian APT: HYPERSCRAPE email theft tool</description>
    <mitre>
      <id>T1114.002</id>
    </mitre>
  </rule>

  <!-- PowerLess Backdoor (Generic) -->
  <rule id="101012" level="15">
    <if_group>sysmon_event_7</if_group>
    <match>system.management.automation.dll</match>
    <description>Iranian APT: PowerLess backdoor detected</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
  </rule>

  <!-- Telegram Targeting -->
  <rule id="101014" level="14">
    <if_group>sysmon_event_11</if_group>
    <match>telegram</match>
    <match>.json</match>
    <description>Iranian APT: Telegram data theft detected</description>
    <mitre>
      <id>T1552.001</id>
    </mitre>
  </rule>

  <!-- Shadow Copy Operations -->
  <rule id="101017" level="14">
    <if_group>sysmon_event_1</if_group>
    <match>vssadmin</match>
    <match>shadows</match>
    <description>Iranian APT: Shadow copy enumeration detected</description>
    <mitre>
      <id>T1490</id>
    </mitre>
  </rule>

  <!-- Log4Shell -->
  <rule id="101020" level="15">
    <if_group>web</if_group>
    <match>${jndi:ldap://</match>
    <description>Iranian APT: Log4Shell exploitation attempt</description>
    <mitre>
      <id>T1190</id>
    </mitre>
  </rule>

  <!-- ========== CORRELATION RULES ========== -->

  <!-- Multiple CVE Attempts -->
  <rule id="100914" level="15" frequency="5" timeframe="60">
    <if_matched_sid>100900,100902,100904,100906,100908</if_matched_sid>
    <description>Iranian APT: Multiple CVE exploitation attempts</description>
    <mitre>
      <id>T1190</id>
    </mitre>
  </rule>

  <!-- Active Compromise -->
  <rule id="100935" level="16" frequency="3" timeframe="300">
    <if_matched_sid>100920,100921,100924,100927</if_matched_sid>
    <description>Iranian APT: Multiple attack stages - active compromise</description>
    <mitre>
      <id>T1486</id>
    </mitre>
  </rule>

  <!-- Multiple C2 Indicators -->
  <rule id="100954" level="16" frequency="5" timeframe="600">
    <if_matched_sid>100941,100944,100949,100952</if_matched_sid>
    <description>Iranian APT: Multiple C2 indicators - active compromise</description>
    <mitre>
      <id>T1102</id>
    </mitre>
  </rule>

  <!-- APT34 Correlation -->
  <rule id="100968" level="12" timeframe="300">
    <if_matched_sid>100961,100962</if_matched_sid>
    <same_field>win.eventdata.user</same_field>
    <description>Iranian APT: APT34/OilRig QUADAGENT persistence pattern detected</description>
    <options>alert_by_email</options>
    <mitre>
      <id>T1053.005</id>
      <id>T1112</id>
    </mitre>
  </rule>

  <!-- MuddyWater Campaign -->
  <rule id="100969" level="15" frequency="2" timeframe="600">
    <if_matched_sid>100960</if_matched_sid>
    <description>Iranian APT: MuddyWater campaign activity detected</description>
    <mitre>
      <id>T1574.002</id>
    </mitre>
  </rule>

  <!-- Charming Kitten Campaign -->
  <rule id="100970" level="15" frequency="2" timeframe="300">
    <if_matched_sid>100963,100964,100965</if_matched_sid>
    <description>Iranian APT: Charming Kitten PowerLess backdoor campaign active</description>
    <options>alert_by_email</options>
    <mitre>
      <id>T1059.001</id>
    </mitre>
  </rule>

  <!-- Campaign Detection -->
  <rule id="101022" level="16" frequency="3" timeframe="3600">
    <if_matched_sid>101000,101006,101008</if_matched_sid>
    <description>Iranian APT: Multiple unique techniques - active campaign</description>
    <mitre>
      <id>T1204</id>
    </mitre>
  </rule>

<!-- ============================================================================
       JUNE 2025 NETWORK UPDATES - APPEND TO 0912-iranian-apt-network-rules.xml  
       Research Date: 2025-06-29
       Network patterns: MQTT C2, Azure abuse, passive backdoors, crypto targeting
       ============================================================================ -->

  <!-- MQTT C2 Communication (IOCONTROL) -->
  <rule id="101144" level="15">
    <if_group>firewall</if_group>
    <dstport>8883|1883</dstport>
    <protocol>tcp</protocol>
    <action>allow</action>
    <description>Iranian APT: MQTT protocol communication to external hosts - possible IOCONTROL C2</description>
    <mitre>
      <id>T0884</id>
      <id>T1071.002</id>
    </mitre>
    <group>attack,mqtt,iocontrol,critical_infrastructure,pci_dss_11.4,</group>
  </rule>

  <!-- Azure Subdomain C2 Pattern -->
  <rule id="101145" level="14">
    <if_group>sysmon_event_22</if_group>
    <field name="win.eventdata.queryName" type="pcre2">^[a-z0-9\-]{8,20}\.azurewebsites\.net$</field>
    <description>Iranian APT: Azure subdomain C2 infrastructure detected - $(win.eventdata.queryName)</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1102.002</id>
    </mitre>
    <group>attack,azure_c2,unc1549,</group>
  </rule>

  <!-- WebSocket Phishing Backend Communication -->
  <rule id="101146" level="15">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationPort">8569|8570|8571</field>
    <field name="win.eventdata.destinationHostname" type="pcre2">(?i)(idea-home|auth-portal|secure-verify)\.online</field>
    <description>Iranian APT: WebSocket phishing backend connection - $(win.eventdata.destinationHostname)</description>
    <mitre>
      <id>T1566.002</id>
      <id>T1071.001</id>
    </mitre>
    <group>attack,websocket_phishing,apt35,react_kit,</group>
  </rule>

  <!-- Cryptocurrency Exchange API Pattern -->
  <rule id="101147" level="15">
    <if_group>firewall</if_group>
    <url type="pcre2">(?i)(nobitex|binance|coinbase).*api.*(withdraw|transfer)</url>
    <status>200</status>
    <description>Iranian APT: Cryptocurrency exchange API access for potential theft</description>
    <mitre>
      <id>T1496</id>
      <id>T1657</id>
    </mitre>
    <group>attack,cryptocurrency,api_theft,</group>
  </rule>

  <!-- Passive Backdoor Inbound Connections -->
  <rule id="101148" level="15">
    <if_group>firewall</if_group>
    <direction>inbound</direction>
    <dstport>443|8443|8080</dstport>
    <action>allow</action>
    <time>22:00-06:00</time>
    <srcip negate="yes">^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])\.)</srcip>
    <description>Iranian APT: Off-hours inbound connection to web service - possible passive backdoor</description>
    <mitre>
      <id>T1205</id>
      <id>T1571</id>
    </mitre>
    <group>attack,passive_backdoor,off_hours,unc1860,</group>
  </rule>

  <!-- Industrial Protocol Abuse -->
  <rule id="101149" level="15">
    <if_group>firewall</if_group>
    <dstport>502|20000|44818</dstport>
    <protocol>tcp</protocol>
    <srcip negate="yes">^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])\.)</srcip>
    <description>Iranian APT: External access to industrial protocols (Modbus/DNP3/EtherNet/IP)</description>
    <mitre>
      <id>T0886</id>
      <id>T0885</id>
    </mitre>
    <group>attack,industrial_protocols,scada,critical_infrastructure,</group>
  </rule>

  <!-- Azure Resource Manager Mass Queries -->
  <rule id="101150" level="14" frequency="20" timeframe="300">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationHostname">management.azure.com</field>
    <same_source_ip />
    <description>Iranian APT: Azure Resource Manager mass enumeration detected</description>
    <mitre>
      <id>T1526</id>
      <id>T1018</id>
    </mitre>
    <group>attack,azure_enumeration,cloud_recon,</group>
  </rule>

  <!-- AI API Abuse for Content Generation -->
  <rule id="101151" level="14">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationHostname" type="pcre2">(?i)(api\.openai\.com|api\.anthropic\.com)</field>
    <field name="win.eventdata.image" negate="yes" type="pcre2">(?i)(chrome|firefox|edge|browser)</field>
    <description>Iranian APT: AI API access from non-browser process - possible content generation</description>
    <mitre>
      <id>T1588.005</id>
      <id>T1566</id>
    </mitre>
    <group>attack,ai_api_abuse,content_generation,</group>
  </rule>

  <!-- Mass Cryptocurrency Exchange Connections -->
  <rule id="101152" level="15" frequency="10" timeframe="600">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationHostname" type="pcre2">(?i)(binance|coinbase|kraken|kucoin|nobitex)</field>
    <same_source_ip />
    <description>Iranian APT: Mass cryptocurrency exchange access - possible theft operation</description>
    <mitre>
      <id>T1496</id>
      <id>T1657</id>
    </mitre>
    <group>attack,cryptocurrency,mass_access,predatory_sparrow,</group>
  </rule>

  <!-- TEMPLEDROP Driver Network Activity -->
  <rule id="101153" level="15">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.image">system</field>
    <field name="win.eventdata.destinationPort">443|8443</field>
    <field name="win.eventdata.destinationIp" negate="yes">^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])\.)</field>
    <description>Iranian APT: System process making external HTTPS connection - possible TEMPLEDROP activity</description>
    <mitre>
      <id>T1014</id>
      <id>T1071.001</id>
    </mitre>
    <group>attack,templedrop,system_network,</group>
  </rule>

  <!-- Industrial Device Reconnaissance -->
  <rule id="101154" level="14" frequency="50" timeframe="300">
    <if_group>firewall</if_group>
    <dstport>80|443|8080|8443</dstport>
    <url type="pcre2">(?i)(login|admin|config|setup|device)</url>
    <same_source_ip />
    <description>Iranian APT: Industrial device web interface scanning detected</description>
    <mitre>
      <id>T1046</id>
      <id>T1595.002</id>
    </mitre>
    <group>attack,industrial_recon,device_scanning,</group>
  </rule>

  <!-- June 2025 Network Campaign Correlation -->
  <rule id="101155" level="17" frequency="3" timeframe="7200">
    <if_matched_sid>101144,101146,101147,101148,101149</if_matched_sid>
    <description>Iranian APT: June 2025 multi-vector network campaign - active nation-state operation</description>
    <mitre>
      <id>T1204</id>
    </mitre>
    <group>attack,june_2025_network_campaign,nation_state,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- Event Log Service Thread Manipulation -->
  <rule id="101133" level="15">
    <if_sid>7034</if_sid>
    <field name="win.system.eventID">7034</field>
    <field name="win.eventdata.serviceName">EventLog</field>
    <description>Iranian APT: Windows Event Log service unexpectedly terminated - possible TEMPLELOCK</description>
    <mitre>
      <id>T1070.001</id>
      <id>T1489</id>
    </mitre>
    <group>attack,service_disruption,templelock,pci_dss_10.2.7,</group>
  </rule>

  <!-- Kernel Driver Certificate Abuse -->
  <rule id="101134" level="15">
    <if_sid>60010</if_sid>
    <field name="win.eventdata.driverName" type="pcre2">(?i)(sheed|iranian.*av|templedrop)</field>
    <description>Iranian APT: Suspicious Iranian antivirus driver loaded - $(win.eventdata.driverName)</description>
    <mitre>
      <id>T1014</id>
      <id>T1547.006</id>
    </mitre>
    <group>attack,kernel_driver,certificate_abuse,pci_dss_10.6.1,</group>
  </rule>

  <!-- Selective Event Log Disabling -->
  <rule id="101135" level="14">
    <if_group>sysmon_event_13</if_group>
    <field name="win.eventdata.targetObject" type="pcre2">(?i)SYSTEM\\CurrentControlSet\\Services\\EventLog</field>
    <field name="win.eventdata.details">0</field>
    <description>Iranian APT: Event logging selectively disabled via registry</description>
    <mitre>
      <id>T1070.001</id>
      <id>T1112</id>
    </mitre>
    <group>attack,registry_evasion,log_disabling,</group>
  </rule>

  <!-- HTTP.sys IOCTL Abuse Detection -->
  <rule id="101136" level="15">
    <if_group>sysmon_event_1</if_group>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)DeviceIoControl.*HTTP|IOCTL.*0x12000C</field>
    <description>Iranian APT: HTTP.sys IOCTL manipulation detected - possible TOFUDRV</description>
    <mitre>
      <id>T1055</id>
      <id>T1106</id>
    </mitre>
    <group>attack,http_sys_abuse,ioctl,unc1860,</group>
  </rule>

  <!-- Azure PowerShell Module Abuse -->
  <rule id="101137" level="14">
    <if_sid>91322</if_sid>
    <field name="win.eventdata.scriptBlockText" type="pcre2">(?i)(New-AzVM|New-AzResourceGroup).*-Location.*"random"</field>
    <description>Iranian APT: Azure PowerShell used for fraudulent resource creation</description>
    <mitre>
      <id>T1078.004</id>
      <id>T1059.001</id>
    </mitre>
    <group>attack,azure_fraud,powershell,pioneer_kitten,</group>
  </rule>

  <!-- Passive Backdoor Service Creation -->
  <rule id="101138" level="15">
    <if_sid>4697</if_sid>
    <field name="win.eventdata.serviceName" type="pcre2">(?i)(health|status|ping|check).*service</field>
    <field name="win.eventdata.serviceFileName" type="pcre2">(?i).*443|.*8443|.*8080</field>
    <description>Iranian APT: Passive backdoor service created - $(win.eventdata.serviceName)</description>
    <mitre>
      <id>T1205</id>
      <id>T1543.003</id>
    </mitre>
    <group>attack,passive_backdoor,service_creation,</group>
  </rule>

  <!-- AI-Generated Content Detection via PowerShell -->
  <rule id="101139" level="14">
    <if_sid>91322</if_sid>
    <field name="win.eventdata.scriptBlockText" type="pcre2">(?i)(Invoke-RestMethod.*openai|gpt.*api.*key|chatgpt.*generate)</field>
    <description>Iranian APT: PowerShell accessing AI APIs for content generation</description>
    <mitre>
      <id>T1588.005</id>
      <id>T1059.001</id>
    </mitre>
    <group>attack,ai_abuse,content_generation,</group>
  </rule>

  <!-- IOCONTROL Industrial Process Manipulation -->
  <rule id="101140" level="15">
    <if_group>sysmon_event_1</if_group>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)(ladder.*logic|plc.*program|scada.*control)</field>
    <field name="win.eventdata.parentImage" negate="yes" type="pcre2">(?i)(rslogix|step7|tia.*portal)</field>
    <description>Iranian APT: IOCONTROL industrial process manipulation detected</description>
    <mitre>
      <id>T0889</id>
      <id>T0871</id>
    </mitre>
    <group>attack,iocontrol,industrial_manipulation,critical_infrastructure,</group>
  </rule>

  <!-- Cryptocurrency Exchange PowerShell Interaction -->
  <rule id="101141" level="15">
    <if_sid>91322</if_sid>
    <field name="win.eventdata.scriptBlockText" type="pcre2">(?i)(nobitex|crypto.*exchange).*api</field>
    <field name="win.eventdata.scriptBlockText" type="pcre2">(?i)(withdraw|transfer).*90000000</field>
    <description>Iranian APT: PowerShell cryptocurrency exchange manipulation detected</description>
    <mitre>
      <id>T1496</id>
      <id>T1657</id>
    </mitre>
    <group>attack,cryptocurrency,exchange_theft,predatory_sparrow,</group>
  </rule>

  <!-- Filter Driver File System Protection Bypass -->
  <rule id="101142" level="14">
    <if_group>sysmon_event_11</if_group>
    <field name="win.eventdata.targetFilename" type="pcre2">(?i)system32\\drivers.*\.(sys|inf)</field>
    <field name="win.eventdata.image" negate="yes">System|pnputil.exe|driverstore.exe</field>
    <description>Iranian APT: Unauthorized driver file creation - possible TEMPLEDROP</description>
    <mitre>
      <id>T1014</id>
      <id>T1036</id>
    </mitre>
    <group>attack,driver_installation,filesystem_evasion,</group>
  </rule>

  <!-- Multiple Windows Technique Correlation -->
  <rule id="101143" level="17" frequency="2" timeframe="3600">
    <if_matched_sid>101133,101134,101136,101140</if_matched_sid>
    <description>Iranian APT: Multiple Windows-specific attack techniques detected - sophisticated compromise</description>
    <mitre>
      <id>T1204</id>
    </mitre>
    <group>attack,windows_campaign,sophisticated,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- TEMPLEDROP Kernel Driver Abuse (Sheed AV) -->
  <rule id="101122" level="15">
    <if_sid>60103</if_sid>
    <field name="win.system.providerName">Microsoft-Windows-CodeIntegrity</field>
    <field name="win.eventdata.fileName" type="pcre2">(?i)(sheed|templedrop|iranian.*av)</field>
    <description>Iranian APT: TEMPLEDROP kernel driver abuse detected - $(win.eventdata.fileName)</description>
    <mitre>
      <id>T1014</id>
      <id>T1547.001</id>
    </mitre>
    <group>attack,kernel_driver,templedrop,pci_dss_10.6.1,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- TEMPLELOCK Event Log Manipulation -->
  <rule id="101123" level="15">
    <if_group>sysmon_event_1</if_group>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)(templelock|eventlog.*thread|log.*service.*kill)</field>
    <description>Iranian APT: TEMPLELOCK event log manipulation detected</description>
    <mitre>
      <id>T1070.001</id>
      <id>T1562.002</id>
    </mitre>
    <group>attack,log_evasion,templelock,pci_dss_10.2.7,</group>
  </rule>

  <!-- Event Log Service Thread Termination -->
  <rule id="101124" level="15">
    <if_group>sysmon_event_8</if_group>
    <field name="win.eventdata.targetImage">services.exe</field>
    <field name="win.eventdata.sourceImage" negate="yes">services.exe|svchost.exe|System</field>
    <description>Iranian APT: Suspicious thread creation in services.exe - possible TEMPLELOCK</description>
    <mitre>
      <id>T1070.001</id>
      <id>T1055</id>
    </mitre>
    <group>attack,thread_injection,services,</group>
  </rule>

  <!-- TOFULOAD/TOFUDRV HTTP.sys Abuse -->
  <rule id="101125" level="14">
    <if_group>sysmon_event_1</if_group>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)(tofuload|tofudrv|http\.sys.*ioctl)</field>
    <description>Iranian APT: TOFULOAD/TOFUDRV HTTP.sys abuse detected</description>
    <mitre>
      <id>T1055</id>
      <id>T1106</id>
    </mitre>
    <group>attack,http_sys_abuse,unc1860,</group>
  </rule>

  <!-- AI-Generated Phishing Process Patterns -->
  <rule id="101126" level="14">
    <if_group>sysmon_event_1</if_group>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)(react.*build|webpack|babel.*compile).*phish</field>
    <description>Iranian APT: AI-generated phishing kit compilation detected</description>
    <mitre>
      <id>T1566.002</id>
      <id>T1588.005</id>
    </mitre>
    <group>attack,ai_phishing,apt35,</group>
  </rule>

  <!-- Passive Backdoor Installation (No Outbound C2) -->
  <rule id="101127" level="14">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.initiated">false</field>
    <field name="win.eventdata.destinationPort">443|8443|8080</field>
    <field name="win.eventdata.image" negate="yes" type="pcre2">(?i)(chrome|firefox|iexplore|edge|winhttp)</field>
    <description>Iranian APT: Passive backdoor accepting inbound connections - $(win.eventdata.image)</description>
    <mitre>
      <id>T1205</id>
      <id>T1571</id>
    </mitre>
    <group>attack,passive_backdoor,unc1860,</group>
  </rule>

  <!-- IOCONTROL MQTT Communication Patterns -->
  <rule id="101128" level="15">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationPort">8883|1883</field>
    <field name="win.eventdata.image" negate="yes" type="pcre2">(?i)(mqtt|mosquitto|hivemq)</field>
    <description>Iranian APT: IOCONTROL MQTT communication from non-MQTT process - $(win.eventdata.image)</description>
    <mitre>
      <id>T0884</id>
      <id>T1071.002</id>
    </mitre>
    <group>attack,iocontrol,mqtt,ics,critical_infrastructure,</group>
  </rule>

  <!-- Cryptocurrency Exchange API Abuse -->
  <rule id="101129" level="15">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationHostname" type="pcre2">(?i)(nobitex|binance|coinbase|kraken).*api</field>
    <field name="win.eventdata.image" negate="yes" type="pcre2">(?i)(chrome|firefox|trading|wallet)</field>
    <description>Iranian APT: Suspicious cryptocurrency exchange API access - $(win.eventdata.destinationHostname)</description>
    <mitre>
      <id>T1496</id>
      <id>T1657</id>
    </mitre>
    <group>attack,cryptocurrency,api_abuse,</group>
  </rule>

  <!-- Azure Resource Manager Abuse -->
  <rule id="101130" level="14">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationHostname">management.azure.com</field>
    <field name="win.eventdata.image" negate="yes" type="pcre2">(?i)(azure|powershell|az|msedge|chrome)</field>
    <description>Iranian APT: Azure Resource Manager access from suspicious process - $(win.eventdata.image)</description>
    <mitre>
      <id>T1078.004</id>
      <id>T1526</id>
    </mitre>
    <group>attack,azure_abuse,cloud,</group>
  </rule>

  <!-- Windows Filter Driver Installation -->
  <rule id="101131" level="15">
    <if_group>sysmon_event_6</if_group>
    <field name="win.eventdata.imagePath" type="pcre2">(?i)(sheed|templedrop|iranian).*\.sys</field>
    <description>Iranian APT: Suspicious filter driver loaded - $(win.eventdata.imagePath)</description>
    <mitre>
      <id>T1014</id>
      <id>T1543.003</id>
    </mitre>
    <group>attack,filter_driver,templedrop,</group>
  </rule>

  <!-- June 2025 Campaign Correlation -->
  <rule id="101132" level="17" frequency="3" timeframe="7200">
    <if_matched_sid>101122,101123,101127,101128,101129</if_matched_sid>
    <description>Iranian APT: June 2025 multi-technique campaign detected - active nation-state threat</description>
    <mitre>
      <id>T1204</id>
    </mitre>
    <group>attack,june_2025_campaign,nation_state,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- CVE-2025-24201: Apple WebKit Zero-Day (Extremely Sophisticated) -->
  <rule id="100920" level="15">
    <if_group>web_scan</if_group>
    <regex>CVE-2025-24201|webkit.*overflow|canvas.*exploit</regex>
    <description>Iranian APT: CVE-2025-24201 Apple WebKit zero-day exploitation attempt</description>
    <mitre>
      <id>T1190</id>
      <id>T1203</id>
    </mitre>
    <group>attack,zero_day,webkit,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- CVE-2025-24085: Core Media Framework Privilege Escalation -->
  <rule id="100921" level="15">
    <if_group>sysmon_event_1</if_group>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)(CVE-2025-24085|coremedia.*exploit|media.*privilege)</field>
    <description>Iranian APT: CVE-2025-24085 Core Media framework exploitation detected</description>
    <mitre>
      <id>T1068</id>
      <id>T1203</id>
    </mitre>
    <group>attack,privilege_escalation,apple,</group>
  </rule>

  <!-- CVE-2025-24200: USB Restricted Mode Bypass -->
  <rule id="100922" level="14">
    <if_group>sysmon_event_11</if_group>
    <field name="win.eventdata.targetFilename" type="pcre2">(?i).*usb.*bypass|CVE-2025-24200</field>
    <description>Iranian APT: CVE-2025-24200 USB Restricted Mode bypass attempt</description>
    <mitre>
      <id>T1200</id>
      <id>T1068</id>
    </mitre>
    <group>attack,usb_attack,</group>
  </rule>

  <!-- CVE-2024-30088: Windows Kernel Elevation (STEALHOOK) -->
  <rule id="100923" level="15">
    <if_group>sysmon_event_1</if_group>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)(CVE-2024-30088|STEALHOOK|kernel.*exploit)</field>
    <description>Iranian APT: CVE-2024-30088 Windows Kernel exploitation with STEALHOOK</description>
    <mitre>
      <id>T1068</id>
      <id>T1055</id>
    </mitre>
    <group>attack,privilege_escalation,kernel,stealhook,pci_dss_10.6.1,</group>
  </rule>

  <!-- June 2025 CVE Exploitation Campaign -->
  <rule id="100924" level="16" frequency="2" timeframe="3600">
    <if_matched_sid>100920,100921,100922,100923</if_matched_sid>
    <description>Iranian APT: June 2025 zero-day exploitation campaign detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1068</id>
    </mitre>
    <group>attack,zero_day_campaign,june_2025,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

</group>
