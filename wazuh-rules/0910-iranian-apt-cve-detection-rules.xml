<!--
  Wazuh Rules for Iranian APT CVE Detection
  Version: 1.0
  Last Updated: 2025-06-25
  
  This ruleset detects exploitation attempts of CVEs commonly used by Iranian threat actors
  including Pioneer Kitten, Lemon Sandstorm, Peach Sandstorm, and IRGC-affiliated groups.
-->

<group name="iranian_apt,cve_detection,">

  <!-- CVE-2024-24919: Check Point Security Gateway Information Disclosure -->
  <rule id="100900" level="15">
    <if_group>web_scan</if_group>
    <url>/clients/MyCRL$</url>
    <description>Iranian APT: Possible CVE-2024-24919 Check Point exploitation attempt</description>
    <mitre>
      <id>T1190</id>
      <id>T1595.002</id>
    </mitre>
    <group>attack,pci_dss_11.4,pci_dss_6.2,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <rule id="100901" level="15">
    <if_group>firewall</if_group>
    <match>Check Point|CheckPoint</match>
    <regex>MyCRL|CSHELL|/clients/MyCRL</regex>
    <description>Iranian APT: CVE-2024-24919 Check Point Security Gateway exploitation detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1210</id>
    </mitre>
    <group>attack,exploit_attempt,</group>
  </rule>

  <!-- CVE-2024-3400: Palo Alto Networks PAN-OS Command Injection -->
  <rule id="100902" level="15">
    <if_group>web_scan</if_group>
    <url>/ssl-vpn/hipreport.esp</url>
    <description>Iranian APT: Possible CVE-2024-3400 PAN-OS exploitation attempt</description>
    <mitre>
      <id>T1190</id>
      <id>T1059</id>
    </mitre>
    <group>attack,command_injection,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <rule id="100903" level="15">
    <if_group>firewall</if_group>
    <match>PAN-OS|GlobalProtect</match>
    <regex>SESSID=\.\.%2F|command injection|arbitrary command</regex>
    <description>Iranian APT: CVE-2024-3400 PAN-OS command injection detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1059</id>
    </mitre>
    <group>attack,exploit_attempt,</group>
  </rule>

  <!-- CVE-2023-3519 & CVE-2019-19781: Citrix NetScaler -->
  <rule id="100904" level="15">
    <if_group>web_scan</if_group>
    <url>/vpn/\.\.\/vpns/|/vpns/portal/scripts/</url>
    <description>Iranian APT: Citrix NetScaler path traversal attempt (CVE-2019-19781/CVE-2023-3519)</description>
    <mitre>
      <id>T1190</id>
      <id>T1083</id>
    </mitre>
    <group>attack,path_traversal,pci_dss_11.4,</group>
  </rule>

  <rule id="100905" level="15">
    <if_group>web_scan</if_group>
    <regex>NSC_|NITRO API|/rapi/|/pcidss/report</regex>
    <match>Citrix|NetScaler</match>
    <description>Iranian APT: Suspicious Citrix NetScaler activity detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1210</id>
    </mitre>
    <group>attack,reconnaissance,</group>
  </rule>

  <!-- CVE-2022-1388: F5 BIG-IP Authentication Bypass -->
  <rule id="100906" level="15">
    <if_group>web_scan</if_group>
    <regex>X-F5-Auth-Token|X-Forwarded-Host:\s*localhost|Connection:\s*X-F5-Auth-Token</regex>
    <description>Iranian APT: F5 BIG-IP CVE-2022-1388 exploitation attempt</description>
    <mitre>
      <id>T1190</id>
      <id>T1548</id>
    </mitre>
    <group>attack,auth_bypass,pci_dss_11.4,</group>
  </rule>

  <rule id="100907" level="15">
    <if_group>web_scan</if_group>
    <url>/mgmt/tm/util/bash</url>
    <description>Iranian APT: F5 BIG-IP command execution attempt</description>
    <mitre>
      <id>T1059.004</id>
      <id>T1190</id>
    </mitre>
    <group>attack,command_injection,</group>
  </rule>

  <!-- CVE-2024-21887: Ivanti Connect Secure Command Injection -->
  <rule id="100908" level="15">
    <if_group>web_scan</if_group>
    <url>/api/v1/license/key-status/</url>
    <regex><![CDATA[\$\(|\`|;|\||<|>|&]]></regex>
    <description>Iranian APT: Ivanti CVE-2024-21887 command injection attempt</description>
    <mitre>
      <id>T1190</id>
      <id>T1059</id>
    </mitre>
    <group>attack,command_injection,pci_dss_11.4,</group>
  </rule>

  <rule id="100909" level="15">
    <if_group>web_scan</if_group>
    <match>Pulse Secure|Ivanti</match>
    <regex>/dana-na/|/dana-cached/|/dana-ws/</regex>
    <description>Iranian APT: Suspicious Ivanti/Pulse Secure access detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1595</id>
    </mitre>
    <group>attack,reconnaissance,</group>
  </rule>

  <!-- CVE-2020-1472: Zerologon Detection -->
  <rule id="100910" level="15">
    <if_group>windows,authentication_failed</if_group>
    <field name="win.eventdata.workstation">\\0\\0\\0\\0\\0\\0\\0\\0</field>
    <description>Iranian APT: Possible Zerologon (CVE-2020-1472) exploitation attempt</description>
    <mitre>
      <id>T1068</id>
      <id>T1210</id>
    </mitre>
    <group>attack,privilege_escalation,pci_dss_10.2.4,gdpr_IV_32.2,</group>
  </rule>

  <rule id="100911" level="15">
    <if_sid>18107</if_sid>
    <field name="win.eventdata.serviceName">netlogon</field>
    <regex>ComputerPasswordSet|ServerPasswordSet</regex>
    <description>Iranian APT: Zerologon attack - Netlogon password reset detected</description>
    <mitre>
      <id>T1068</id>
      <id>T1078</id>
    </mitre>
    <group>attack,privilege_escalation,</group>
  </rule>

  <!-- ZKTeco BioTime Vulnerabilities -->
  <rule id="100912" level="14">
    <if_group>web_scan</if_group>
    <match>ZKTeco|BioTime</match>
    <regex>/iclock/|/files/|/media/</regex>
    <description>Iranian APT: ZKTeco BioTime reconnaissance detected</description>
    <mitre>
      <id>T1595</id>
      <id>T1190</id>
    </mitre>
    <group>attack,reconnaissance,</group>
  </rule>

  <!-- CVE-2021-26855: Exchange Server ProxyLogon -->
  <rule id="100915" level="15">
    <if_group>web_scan</if_group>
    <url>/owa/auth/x.js</url>
    <description>Iranian APT: Exchange ProxyLogon (CVE-2021-26855) exploitation attempt</description>
    <mitre>
      <id>T1190</id>
      <id>T1505.003</id>
    </mitre>
    <group>attack,exchange,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <rule id="100916" level="15">
    <if_group>web_scan</if_group>
    <match>X-AnonResource-Backend|X-BEResource</match>
    <url>/ecp/|/owa/</url>
    <description>Iranian APT: Exchange Server suspicious headers detected (CVE-2021-26855)</description>
    <mitre>
      <id>T1190</id>
      <id>T1203</id>
    </mitre>
    <group>attack,exchange,</group>
  </rule>

  <rule id="100917" level="15">
    <if_group>web_scan</if_group>
    <regex>autodiscover.*Powershell|autodiscover.*mapi/nspi</regex>
    <description>Iranian APT: Exchange autodiscover abuse detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1114.002</id>
    </mitre>
    <group>attack,exchange,</group>
  </rule>

  <!-- CVE-2023-23397: Outlook Elevation of Privilege -->
  <rule id="100918" level="15">
    <if_group>windows</if_group>
    <match>Outlook.exe</match>
    <regex>\\\\.*\pipe\|\\\\.*\PIPE\|\\\\.*SMB|UNC.*reminder</regex>
    <description>Iranian APT: Outlook CVE-2023-23397 NTLM relay attempt detected</description>
    <mitre>
      <id>T1187</id>
      <id>T1557.001</id>
    </mitre>
    <group>attack,credential_access,pci_dss_10.6.1,</group>
  </rule>

  <rule id="100919" level="15">
    <if_group>sysmon_event_22</if_group>
    <field name="win.eventdata.image">outlook.exe</field>
    <field name="win.eventdata.queryName" type="pcre2">^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$</field>
    <description>Iranian APT: Outlook making suspicious direct IP DNS query (CVE-2023-23397)</description>
    <mitre>
      <id>T1187</id>
      <id>T1040</id>
    </mitre>
    <group>attack,credential_access,</group>
  </rule>

  <!-- Generic VPN/Firewall Exploitation Patterns -->
  <rule id="100913" level="14">
    <if_group>firewall,web_scan</if_group>
    <regex>Shodan|ShodanHost|Censys|ZoomEye|Fofa</regex>
    <description>Iranian APT: Internet scanning tool user-agent detected</description>
    <mitre>
      <id>T1595.001</id>
      <id>T1595.002</id>
    </mitre>
    <group>attack,reconnaissance,</group>
  </rule>

  <rule id="100914" level="15" frequency="5" timeframe="60">
    <if_matched_sid>100900,100902,100904,100906,100908</if_matched_sid>
    <description>Iranian APT: Multiple CVE exploitation attempts detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1210</id>
      <id>T1595</id>
    </mitre>
    <group>attack,multiple_attacks,pci_dss_11.4,</group>
  </rule>

</group>
