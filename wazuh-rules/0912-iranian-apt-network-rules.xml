<!--
  Wazuh Rules for Iranian APT Network Detection
  Version: 1.0
  Last Updated: 2025-06-25
  
  This ruleset detects network-based indicators associated with Iranian threat actors
  including C2 communication patterns, data exfiltration, and scanning activities.
-->

<group name="iranian_apt,network_detection,">

  <!-- C2 Communication Patterns -->
  <rule id="100940" level="14">
    <if_group>firewall</if_group>
    <srcport>20256</srcport>
    <description>Iranian APT: Unitronics PLC default port communication detected</description>
    <mitre>
      <id>T1571</id>
      <id>T1095</id>
    </mitre>
    <group>attack,command_control,scada,</group>
  </rule>

  <rule id="100941" level="14">
    <if_group>web_log</if_group>
    <regex>User-Agent.*\(compatible\s*;\s*$\)|User-Agent.*Python|User-Agent.*curl|User-Agent.*wget</regex>
    <status>200</status>
    <description>Iranian APT: Suspicious automated tool user-agent detected</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1595</id>
    </mitre>
    <group>attack,reconnaissance,</group>
  </rule>

  <!-- Data Exfiltration Patterns -->
  <rule id="100942" level="14">
    <if_group>firewall</if_group>
    <protocol>tcp</protocol>
    <dstport>443|8443|8080</dstport>
    <action>allow</action>
    <bytes_sent type="pcre2">^[5-9]\d{6,}|^[1-9]\d{7,}</bytes_sent>
    <description>Iranian APT: Large data transfer to external host detected (>5MB)</description>
    <mitre>
      <id>T1041</id>
      <id>T1048</id>
    </mitre>
    <group>attack,exfiltration,pci_dss_11.4,</group>
  </rule>

  <rule id="100943" level="15" frequency="5" timeframe="300">
    <if_matched_sid>100942</if_matched_sid>
    <same_dst_ip />
    <description>Iranian APT: Multiple large data transfers to same destination - possible exfiltration</description>
    <mitre>
      <id>T1041</id>
      <id>T1567</id>
    </mitre>
    <group>attack,exfiltration,pci_dss_11.4,gdpr_IV_32.2,</group>
  </rule>

  <!-- Cobalt Strike Detection -->
  <rule id="100944" level="15">
    <if_group>ids</if_group>
    <regex>Cobalt Strike|cobaltstrike|beacon\.dll|artifact\.exe</regex>
    <description>Iranian APT: Cobalt Strike beacon detected</description>
    <mitre>
      <id>T1001</id>
      <id>T1095</id>
    </mitre>
    <group>attack,command_control,cobalt_strike,</group>
  </rule>

  <rule id="100945" level="14">
    <if_group>firewall,web_log</if_group>
    <url type="pcre2">/[a-zA-Z0-9]{1,4}$|/pixel\.gif$|/g\.gif$|/p\.gif$</url>
    <status>200</status>
    <description>Iranian APT: Potential Cobalt Strike C2 communication pattern</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1132</id>
    </mitre>
    <group>attack,command_control,</group>
  </rule>

  <!-- Scanning and Reconnaissance -->
  <rule id="100946" level="13" frequency="50" timeframe="60">
    <if_group>firewall</if_group>
    <action>drop|deny|reject</action>
    <same_src_ip />
    <description>Iranian APT: Port scanning detected from $(src_ip)</description>
    <mitre>
      <id>T1046</id>
      <id>T1595.001</id>
    </mitre>
    <group>attack,reconnaissance,pci_dss_11.4,</group>
  </rule>

  <rule id="100947" level="14">
    <if_group>firewall</if_group>
    <dstport>445|3389|22|23|21|1433|3306</dstport>
    <action>allow</action>
    <src_ip>!192.168.0.0/16,!10.0.0.0/8,!172.16.0.0/12</src_ip>
    <description>Iranian APT: External access to sensitive service on port $(dstport)</description>
    <mitre>
      <id>T1021</id>
      <id>T1133</id>
    </mitre>
    <group>attack,initial_access,</group>
  </rule>

  <!-- DNS Tunneling Detection -->
  <rule id="100948" level="14">
    <if_group>sysmon_event_22</if_group>
    <field name="win.eventdata.queryName" type="pcre2">^[a-f0-9]{32,}\.|^[a-zA-Z0-9+/]{40,}\.</field>
    <description>Iranian APT: Possible DNS tunneling detected - suspicious query pattern</description>
    <mitre>
      <id>T1071.004</id>
      <id>T1048.003</id>
    </mitre>
    <group>attack,command_control,</group>
  </rule>

  <!-- Known Iranian C2 Infrastructure Patterns -->
  <rule id="100949" level="15">
    <if_group>sysmon_event_22,firewall,web_log</if_group>
    <regex>apps\.gist\.githubapp|gupdate\.net|microsoft-update\.net|windows-update\.org</regex>
    <description>Iranian APT: Known C2 infrastructure domain detected</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1102.002</id>
    </mitre>
    <group>attack,command_control,pci_dss_11.4,</group>
  </rule>

  <!-- Encrypted Channel Detection -->
  <rule id="100950" level="13">
    <if_group>firewall</if_group>
    <protocol>tcp</protocol>
    <dstport>!80,!443,!22,!3389</dstport>
    <regex>TLS|SSL|encrypted</regex>
    <description>Iranian APT: Encrypted communication on non-standard port $(dstport)</description>
    <mitre>
      <id>T1573</id>
      <id>T1571</id>
    </mitre>
    <group>attack,command_control,</group>
  </rule>

  <!-- BitCoin Activity Detection -->
  <rule id="100951" level="14">
    <if_group>web_log,sysmon_event_22</if_group>
    <regex>bitcoin|btc|bc1q|blockchain\.info|coinbase</regex>
    <description>Iranian APT: Cryptocurrency-related activity detected - possible ransomware</description>
    <mitre>
      <id>T1486</id>
      <id>T1657</id>
    </mitre>
    <group>attack,ransomware,</group>
  </rule>

  <!-- Ngrok/Tunneling Detection -->
  <rule id="100952" level="15">
    <if_group>firewall,sysmon_event_3</if_group>
    <regex>ngrok\.io|\.ngrok\.com|tunnels\.api\.tunnels|localhost\.run</regex>
    <description>Iranian APT: Reverse tunnel service detected - $(url)</description>
    <mitre>
      <id>T1090.001</id>
      <id>T1572</id>
    </mitre>
    <group>attack,command_control,pci_dss_11.4,</group>
  </rule>

  <!-- Off-Hours Activity -->
  <rule id="100953" level="13">
    <if_group>firewall</if_group>
    <time>22:00-06:00</time>
    <weekday>saturday|sunday</weekday>
    <action>allow</action>
    <protocol>tcp</protocol>
    <bytes_sent type="pcre2">^[1-9]\d{5,}</bytes_sent>
    <description>Iranian APT: Suspicious off-hours network activity detected</description>
    <mitre>
      <id>T1029</id>
      <id>T1048</id>
    </mitre>
    <group>attack,exfiltration,</group>
  </rule>

  <!-- Exchange/Outlook Network Activity -->
  <rule id="100955" level="15">
    <if_group>web_log</if_group>
    <url type="pcre2">/owa/auth/.*\.aspx|/ecp/.*\.aspx|/aspnet_client/.*\.aspx</url>
    <status>200|201</status>
    <description>Iranian APT: Suspicious Exchange web shell access pattern</description>
    <mitre>
      <id>T1505.003</id>
      <id>T1190</id>
    </mitre>
    <group>attack,webshell,exchange,</group>
  </rule>

  <rule id="100956" level="14">
    <if_group>firewall</if_group>
    <protocol>tcp</protocol>
    <srcport>445|139</srcport>
    <program_name>outlook.exe</program_name>
    <description>Iranian APT: Outlook initiating SMB connection - possible CVE-2023-23397</description>
    <mitre>
      <id>T1187</id>
      <id>T1557</id>
    </mitre>
    <group>attack,credential_relay,</group>
  </rule>

  <rule id="100957" level="15">
    <if_group>web_log</if_group>
    <regex>POST.*\/owa\/auth\/Current\/.*themes|POST.*\/ecp\/default\.flt</regex>
    <description>Iranian APT: Exchange ProxyLogon exploitation pattern detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1203</id>
    </mitre>
    <group>attack,exploit,exchange,</group>
  </rule>

  <!-- Combined Network Indicators -->
  <rule id="100954" level="16" frequency="5" timeframe="600">
    <if_matched_sid>100941,100945,100948,100949,100952</if_matched_sid>
    <description>Iranian APT: Multiple C2 indicators detected - active compromise likely</description>
    <mitre>
      <id>T1102</id>
      <id>T1095</id>
    </mitre>
    <group>attack,command_control,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

<!-- ============================================================================
       JUNE 2025 NETWORK UPDATES - APPEND TO 0912-iranian-apt-network-rules.xml  
       Research Date: 2025-06-27
       Network patterns: MQTT C2, Azure abuse, passive backdoors, crypto targeting
       ============================================================================ -->

  <!-- MQTT C2 Communication (IOCONTROL) -->
  <rule id="101144" level="15">
    <if_group>firewall</if_group>
    <dstport>8883|1883</dstport>
    <protocol>tcp</protocol>
    <action>allow</action>
    <description>Iranian APT: MQTT protocol communication to external hosts - possible IOCONTROL C2</description>
    <mitre>
      <id>T0884</id>
      <id>T1071.002</id>
    </mitre>
    <group>attack,mqtt,iocontrol,critical_infrastructure,pci_dss_11.4,</group>
  </rule>

  <!-- Azure Subdomain C2 Pattern -->
  <rule id="101145" level="14">
    <if_group>sysmon_event_22</if_group>
    <field name="win.eventdata.queryName" type="pcre2">^[a-z0-9\-]{8,20}\.azurewebsites\.net$</field>
    <description>Iranian APT: Azure subdomain C2 infrastructure detected - $(win.eventdata.queryName)</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1102.002</id>
    </mitre>
    <group>attack,azure_c2,unc1549,</group>
  </rule>

  <!-- WebSocket Phishing Backend Communication -->
  <rule id="101146" level="15">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationPort">8569|8570|8571</field>
    <field name="win.eventdata.destinationHostname" type="pcre2">(?i)(idea-home|auth-portal|secure-verify)\.online</field>
    <description>Iranian APT: WebSocket phishing backend connection - $(win.eventdata.destinationHostname)</description>
    <mitre>
      <id>T1566.002</id>
      <id>T1071.001</id>
    </mitre>
    <group>attack,websocket_phishing,apt35,react_kit,</group>
  </rule>

  <!-- Cryptocurrency Exchange API Pattern -->
  <rule id="101147" level="15">
    <if_group>firewall</if_group>
    <url type="pcre2">(?i)(nobitex|binance|coinbase).*api.*(withdraw|transfer)</url>
    <status>200</status>
    <description>Iranian APT: Cryptocurrency exchange API access for potential theft</description>
    <mitre>
      <id>T1496</id>
      <id>T1657</id>
    </mitre>
    <group>attack,cryptocurrency,api_theft,</group>
  </rule>

  <!-- Passive Backdoor Inbound Connections -->
  <rule id="101148" level="15">
    <if_group>firewall</if_group>
    <direction>inbound</direction>
    <dstport>443|8443|8080</dstport>
    <action>allow</action>
    <time>22:00-06:00</time>
    <srcip negate="yes">^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])\.)</srcip>
    <description>Iranian APT: Off-hours inbound connection to web service - possible passive backdoor</description>
    <mitre>
      <id>T1205</id>
      <id>T1571</id>
    </mitre>
    <group>attack,passive_backdoor,off_hours,unc1860,</group>
  </rule>

  <!-- Industrial Protocol Abuse -->
  <rule id="101149" level="15">
    <if_group>firewall</if_group>
    <dstport>502|20000|44818</dstport>
    <protocol>tcp</protocol>
    <srcip negate="yes">^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])\.)</srcip>
    <description>Iranian APT: External access to industrial protocols (Modbus/DNP3/EtherNet/IP)</description>
    <mitre>
      <id>T0886</id>
      <id>T0885</id>
    </mitre>
    <group>attack,industrial_protocols,scada,critical_infrastructure,</group>
  </rule>

  <!-- Azure Resource Manager Mass Queries -->
  <rule id="101150" level="14" frequency="20" timeframe="300">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationHostname">management.azure.com</field>
    <same_source_ip />
    <description>Iranian APT: Azure Resource Manager mass enumeration detected</description>
    <mitre>
      <id>T1526</id>
      <id>T1018</id>
    </mitre>
    <group>attack,azure_enumeration,cloud_recon,</group>
  </rule>

  <!-- AI API Abuse for Content Generation -->
  <rule id="101151" level="14">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationHostname" type="pcre2">(?i)(api\.openai\.com|api\.anthropic\.com)</field>
    <field name="win.eventdata.image" negate="yes" type="pcre2">(?i)(chrome|firefox|edge|browser)</field>
    <description>Iranian APT: AI API access from non-browser process - possible content generation</description>
    <mitre>
      <id>T1588.005</id>
      <id>T1566</id>
    </mitre>
    <group>attack,ai_api_abuse,content_generation,</group>
  </rule>

  <!-- Mass Cryptocurrency Exchange Connections -->
  <rule id="101152" level="15" frequency="10" timeframe="600">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.destinationHostname" type="pcre2">(?i)(binance|coinbase|kraken|kucoin|nobitex)</field>
    <same_source_ip />
    <description>Iranian APT: Mass cryptocurrency exchange access - possible theft operation</description>
    <mitre>
      <id>T1496</id>
      <id>T1657</id>
    </mitre>
    <group>attack,cryptocurrency,mass_access,predatory_sparrow,</group>
  </rule>

  <!-- TEMPLEDROP Driver Network Activity -->
  <rule id="101153" level="15">
    <if_group>sysmon_event_3</if_group>
    <field name="win.eventdata.image">system</field>
    <field name="win.eventdata.destinationPort">443|8443</field>
    <field name="win.eventdata.destinationIp" negate="yes">^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])\.)</field>
    <description>Iranian APT: System process making external HTTPS connection - possible TEMPLEDROP activity</description>
    <mitre>
      <id>T1014</id>
      <id>T1071.001</id>
    </mitre>
    <group>attack,templedrop,system_network,</group>
  </rule>

  <!-- Industrial Device Reconnaissance -->
  <rule id="101154" level="14" frequency="50" timeframe="300">
    <if_group>firewall</if_group>
    <dstport>80|443|8080|8443</dstport>
    <url type="pcre2">(?i)(login|admin|config|setup|device)</url>
    <same_source_ip />
    <description>Iranian APT: Industrial device web interface scanning detected</description>
    <mitre>
      <id>T1046</id>
      <id>T1595.002</id>
    </mitre>
    <group>attack,industrial_recon,device_scanning,</group>
  </rule>

  <!-- June 2025 Network Campaign Correlation -->
  <rule id="101155" level="17" frequency="3" timeframe="7200">
    <if_matched_sid>101144,101146,101147,101148,101149</if_matched_sid>
    <description>Iranian APT: June 2025 multi-vector network campaign - active nation-state operation</description>
    <mitre>
      <id>T1204</id>
    </mitre>
    <group>attack,june_2025_network_campaign,nation_state,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>


</group>
